{"ts":1347280905288,"silentsave":true,"restoring":false,"patch":[[]],"length":0}
{"contributors":[],"silentsave":false,"ts":1347280915751,"patch":[[{"diffs":[[1,"\nfunction Game(canvas, ctx){\n    var that = this;\n    \n    this.canvas = canvas;\n    this.ctx = ctx;\n    this.width = canvas.width;\n    this.height = canvas.height;\n    this.mouse = {x: this.width/2, y: 0};\n    this.bullets = [];\n    this.enemies = [];\n    this.tower = new Tower(this.width/2, this.height, 10, 20, 'rgb(0,0,0)');\n    this.viewfinder = new Viewfinder(0, 0, 20, 20, 'rgb(0,0,0)');\n    this.toClean = 0;\n    this.enemiesToClean = 0;\n    \n    this.createEnemies = setInterval(function() {\n        that.addEnemy = true;\n    }, 1000);\n    \n}\nGame.prototype.clear = function(){\n    this.ctx.fillStyle = 'rgb(245,245,245)';\n    this.ctx.fillRect( 0, 0, 255, 255 );\n}\n\n\n\nGame.prototype.draw = function(){\n    this.clear();\n    \n    if(this.addBullet){\n        var mouse = this.mouse;\n\n        //todo\n        var atan = game.tower.getRotate(mouse);           \n        game.bullets.push( new Bullet(game.tower.x, game.tower.y, 5, atan, 'rgba(125, 50, 50, 1)') );\n        this.addBullet = false;\n    }\n    if(this.addEnemy){\n        var x = Math.floor(Math.random() * this.width) + 1;\n        game.enemies.push( new Enemy(x, 0, 20, 20, 'rgba(125, 50, 50, 1)') );\n        this.addEnemy = false;\n    }\n    //enemies\n    var enemies = this.enemies;\n    var l = ( enemies && enemies.length) ? enemies.length : 0;\n    for (var i = 0; i < l; i++) {\n      var enemy = enemies[i];\n      \n      // We can skip the drawing of elements that have moved off the screen:\n      if (!enemy || enemy.y > this.height ){\n              \n              enemies[i] = false;\n              this.enemiesToClean++;\n              \n        }else{\n            enemies[i].draw(this.ctx);\n        }\n    }\n    \n    \n    \n    //Bullets\n    var shapes = this.bullets;\n    \n \n    // ** Add stuff you want drawn in the background all the time here **\n    this.tower.draw(this.ctx, this.mouse);\n    this.viewfinder.draw(this.ctx, this.mouse);\n \n    // draw all shapes\n    var l = ( shapes && shapes.length) ? shapes.length : 0;\n    for (var i = 0; i < l; i++) {\n      var shape = shapes[i];\n      \n      // We can skip the drawing of elements that have moved off the screen:\n      if (!shape || shape.x > this.width || shape.y > this.height ||\n          shape.x + shape.w < 0 || shape.y + shape.h < 0 || shape.offset > this.height){\n              \n              shapes[i] = false;\n              this.toClean++;\n              \n        }else{\n            shapes[i].draw(this.ctx);\n        }\n    }\n    \n    if(this.toClean > 2){\n        //console.log('clean', l);\n        this.bullets = shapes.filter(function(e){return e});\n        //console.log('cleaned: ', this.bullets.length);\n        this.toClean = 0;\n    }\n    if(this.enemiesToClean > 2){\n        //console.log('enemies clean', l);\n        this.enemies = enemies.filter(function(e){return e});\n        //console.log('enemies cleaned: ', this.enemies.length);\n        this.enemiesToClean = 0;\n    }\n}"]],"start1":0,"start2":0,"length1":0,"length2":2921}]],"length":2921,"saved":false}
{"ts":1347281057996,"patch":[[{"diffs":[[0,"\n    }\n}"],[1,"\n\n\n\nGame.prototype.getMouse = function(e) {\n  var element = canvas, offsetX = 0, offsetY = 0, mx, my;\n \n  // Compute the total offset\n  if (element.offsetParent !== undefined) {\n    do {\n      offsetX += element.offsetLeft;\n      offsetY += element.offsetTop;\n    } while ((element = element.offsetParent));\n  }\n \n  // Add padding and border style widths to offset\n  // Also add the <html> offsets in case there's a position:fixed bar\n  //offsetX += this.stylePaddingLeft + this.styleBorderLeft + this.htmlLeft;\n  //offsetY += this.stylePaddingTop + this.styleBorderTop + this.htmlTop;\n if( e.targetTouches && e.targetTouches[0] ){\n     mx = e.targetTouches[0].pageX - offsetX;\n     my = e.targetTouches[0].pageY - offsetY;\n }else{\n      mx = e.pageX - offsetX;\n      my = e.pageY - offsetY;\n }\n \n  // We return a simple javascript object (a hash) with x and y defined\n  return {x: mx, y: my};\n}\n\n"]],"start1":2913,"start2":2913,"length1":8,"length2":905}]],"length":3818,"saved":false}
{"ts":1347281517791,"patch":[[{"diffs":[[0,"    var "],[-1,"atan"],[1,"d"],[0," = game."]],"start1":812,"start2":812,"length1":20,"length2":17},{"diffs":[[0,".get"],[-1,"Rotate"],[1,"Diffs"],[0,"(mou"]],"start1":834,"start2":834,"length1":14,"length2":13},{"diffs":[[0," 5, "],[-1,"atan"],[1,"d.dx, d.dy"],[0,", 'r"]],"start1":928,"start2":928,"length1":12,"length2":18},{"diffs":[[0," y: my};\n}\n\n"],[1,"\n"]],"start1":3808,"start2":3808,"length1":12,"length2":13}]],"length":3821,"saved":false}
{"contributors":[],"silentsave":false,"ts":1349876089363,"patch":[[{"diffs":[[0,".bullets"],[1,"Pool"],[0," = [];\n "]],"start1":215,"start2":215,"length1":16,"length2":20},{"diffs":[[0,".enemies"],[1,"Pool"],[0," = [];\n "]],"start1":242,"start2":242,"length1":16,"length2":20},{"diffs":[[0,"his."],[-1,"tower = new Tower(this.width/2, this.height, 10, 20, 'rgb(0,0,0)');\n    this.viewfinder = new Viewfinder(0, 0, 20, 20, 'rgb(0,0,0)');\n    this.toClean = 0;\n    this.enemiesToClean = 0;\n    \n"],[1,"bullets = [];\n    this.enemies = [];\n    \n    this.currentLevel = 0;\n    this.levels = [{\n        bulletsTimeout: 400,\n        enemiesTimeout: 600,\n        startEnemies: 30,\n        enemies: 30\n    }];\n    this.tower = new Tower(this.width/2, this.height, 10, 20, 'rgb(0,0,0)');\n    this.viewfinder = new Viewfinder(0, 0, 20, 20, 'rgb(0,0,0)');\n    this.toClean = 0;\n    this.enemiesToClean = 0;\n    this.addEnemy = 1;\n    this.score = 0;\n    this.lifes = 3;\n    this.beforeStart = true;\n    this.tweetHandler = false;\n    \n    this.bulletsTimeout = 400;\n    function bulletsFactory(){\n        that.addBullet = true;        \n        setTimeout(bulletsFactory, that.bulletsTimeout);\n    }\n    bulletsFactory();\n    \n    this.enemiesTimeout = 600;\n    function enemiesFactory(){\n        that.addEnemy = true;\n        setTimeout(enemiesFactory, that.enemiesTimeout);\n    }\n    enemiesFactory();\n    \n//"],[0,"    "]],"start1":266,"start2":266,"length1":198,"length2":907},{"diffs":[[0,"unction() {\n"],[1,"//"],[0,"        that"]],"start1":1207,"start2":1207,"length1":24,"length2":26},{"diffs":[[0,"emy = true;\n"],[1,"//"],[0,"    }, 1000)"]],"start1":1239,"start2":1239,"length1":24,"length2":26},{"diffs":[[0,"   \n"],[-1,"}\nGame.prototype.clear = function(){\n    this.ctx.fillStyle = 'rgb(245,245,245)';\n    this.ctx.fillRect( 0, 0, 255, 255 );\n}\n\n\n\nGame.prototype.draw = function(){\n    this.clear();"],[1,"//     this.createBullets = setInterval(function() {\n//        that.addBullet = true;\n//    }, 400);\n    \n}\n\nGame.prototype.startFactories = function(){\n    \n}\n\nGame.prototype.image = new Image();\nGame.prototype.image.src = 'data:image/  png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AkLDSMPVfdqJwAAAWRJREFUOMttk79rwlAQxz9B5UEEFwmCZigGMhQydyiEjkKhf1P/HbeOmfo3FC2CgpkMFDIIAVOC2nSwl96L3vbuvbv7/rjnHA5v9XZXkaU5k6lH4Btcd4BEWRZsdxWBb9juqiYvZ2exntf6UjeSQmkozbI0B2Ay9ei8PD+9njqGwDfsizOPD3eMhn2Ox4p9cebz44vvHxgN+/R6htGwz3hsOHUMWZrj1PV7LZ11BL4BuJnXlJzFel5naU4c+xY8gDj2AXDdAUmyas6SA+gKF4Ao9Kzp+uFsdm8hKcsCwKYgha47sAQTUdt3AI7YKNNvqa1RiivyxrIxS3MLqsDU6DSthkKSrJop7YUqy6IpWG5ya6Gi0Ls0WG7yK+v0Qz29bauzWM/rKPSsSRq+LrxlcTfwDf8ILsKIoHqaXl+txdVfaG+bjraFzSK14YH3d/Zaol2aRCEN5W4bnqgvumgK4pA4UJYFvxvMELAqKY7sAAAAAElFTkSuQmCC';\n\nGame.prototype.clear = function(){\n    this.ctx.fillStyle = 'rgb(245,245,245)';\n    this.ctx.fillRect( 0, 0, this.width, this.height );    \n}\n\nGame.prototype.tile = function(){\n    \n    for (x = 0; x <= this.width; x = x + 16) {\n            for (y = 0; y <= this.width; y = y + 16) {\n                this.ctx.drawImage(this.image, x, y);\n            }\n        }\n    \n}\n\n\n\n\nGame.prototype.draw = function(){\n    var that = this;\n    if(this.beforeStart){\n        this.clear();\n        this.drawSplash(this.ctx);\n        this.canvas.addEventListener('click', function(e){\n            var timeout = 0;\n            if(that.blockClick){\n                return;   \n            }           \n            that.beforeStart = false;\n        });        \n        return;   \n    }\n    if(this.lifes < 1){\n        this.clear();\n        this.drawResult(this.ctx);  \n        \n        if(!this.tweetHandler){\n            this.canvas.addEventListener('click', function(e){\n                window.open( 'https://twitter.com/share?url='+\n                    encodeURIComponent(location.href)+\n                    '&text='+\n                    encodeURIComponent('Just ended Canon Defense! One of #js13kgames My score is: ' + that.score + '. Try the game at: ')\n                ,'_blank' );\n            });\n            this.tweetHandler = true;\n        }\n        return;\n    }"],[0,"\n   "]],"start1":1268,"start2":1268,"length1":187,"length2":2243},{"diffs":[[0,".mouse;\n"],[1,"        that.bulletsTimeout -= 0.1;"],[0,"\n       "]],"start1":3561,"start2":3561,"length1":16,"length2":51},{"diffs":[[0,"(mouse);"],[-1,"           "],[0,"\n       "]],"start1":3655,"start2":3655,"length1":27,"length2":16},{"diffs":[[0,"er.x"],[-1,", game.tower.y"],[1," + (20 * d.dx), game.tower.y + (20 * d.dy)"],[0,", 5,"]],"start1":3710,"start2":3710,"length1":22,"length2":50},{"diffs":[[0,"d.dy, 'rgba("],[-1,"125"],[1,"0"],[0,", "],[-1,"5"],[0,"0, "],[-1,"5"],[0,"0, 1)') );\n "]],"start1":3767,"start2":3767,"length1":34,"length2":30},{"diffs":[[0,"    "],[-1,"if(this.addEnemy){"],[1,"\n    var level = this.levels[this.currentLevel];\n    \n    \n    \n    \n    if(level.enemies && this.addEnemy){\n        \n        this.enemiesTimeout -= 0.9;\n        "],[0,"\n   "]],"start1":3834,"start2":3834,"length1":26,"length2":170},{"diffs":[[0,"dom() * "],[1,"("],[0,"this.wid"]],"start1":4036,"start2":4036,"length1":16,"length2":17},{"diffs":[[0,"idth"],[-1,") + 1"],[1," - 26)) + 2;\n        //var x = Math.floor(Math.random() * (this.width /2)) + this.width /2"],[0,";\n  "]],"start1":4051,"start2":4051,"length1":13,"length2":98},{"diffs":[[0,"nemy(x, 0, 2"],[-1,"0"],[1,"6"],[0,", "],[1,"3"],[0,"2"],[-1,"0"],[0,", 'rgba(125,"]],"start1":4179,"start2":4179,"length1":29,"length2":29},{"diffs":[[0,"dEnemy = false;\n"],[1,"        level.enemies--;\n"],[0,"    }\n    //enem"]],"start1":4240,"start2":4240,"length1":32,"length2":57},{"diffs":[[0,"ies.length : 0;\n"],[1,"    //Bullets\n    var bullets = this.bullets;\n    var bl = ( bullets && bullets.length) ? bullets.length : 0;\n    \n    var collision = false;\n    var yCollision = false;\n    \n    if(l && bl){\n        for (var i = 0; i < l; i++) {\n            var enemy = enemies[i];\n            if(enemy && enemy.live){\n                for (var j = 0; j < bl; j++) {\n                    var b = bullets[j];\n                    if(b){\n                        collision = false;\n                        yCollision = false;\n                        \n                        //a.y < b.y + b.height &&\n                        // a.y + a.height > b.y\n                        var eTopY = enemy.y;\n                        var eBottomY = enemy.y + enemy.h;\n                        var bTopY = b.y - b.w;\n                        var bBottomY = b.y + b.w;\n                        if( eTopY < bBottomY &&\n                         eBottomY > bTopY){\n                           //console.log('y collision b:'+j+' e:'+i);\n                           yCollision = true;\n                             \n                        }\n                        \n                        //look for collisions\n                        var eLeftX = enemy.x;\n                        var eRightX = enemy.x + enemy.w;\n                        var bLeftX = b.x - b.w;\n                        var bRightX = b.x + b.w;\n                        \n                        if(yCollision && \n                         eLeftX < bRightX &&\n                         eRightX > bLeftX ){\n                           //console.log('x collision b:'+j+' e:'+i);\n                           collision = true;\n                             \n                        }\n                        \n                        \n                        \n                        if(collision){\n                            console.log('BUUM!!!!');\n                             enemies[i].kill();\n                             bullets[j] = false;\n                             this.enemiesToClean++;\n                             this.toClean++;\n                             this.score++;\n                             break;\n                        }\n                       \n                    }\n                }\n            }\n        }\n    }\n    \n    this.tile();\n    \n"],[0,"    for (var i ="]],"start1":4380,"start2":4380,"length1":32,"length2":2309},{"diffs":[[0,"\n              \n"],[1,"              //enemy at the bottom!!!!!\n              if(enemy){\n                this.lifes--;\n              }\n              \n"],[0,"              en"]],"start1":6865,"start2":6865,"length1":32,"length2":159},{"diffs":[[0,"emiesToClean++;\n"],[1,"              continue;\n"],[0,"              \n "]],"start1":7063,"start2":7063,"length1":32,"length2":56},{"diffs":[[0," \n        }else{"],[1,"            "],[0,"\n            ene"]],"start1":7116,"start2":7116,"length1":32,"length2":44},{"diffs":[[0,"i].draw(this.ctx"],[-1,");"],[1,", i);\n            if(enemy.toRemove){\n                enemies[i] = false;\n                this.enemiesToClean++;\n            }"],[0,"\n        }\n    }"]],"start1":7165,"start2":7165,"length1":34,"length2":158},{"diffs":[[0,"    }\n        }\n"],[1,"        \n"],[0,"    }\n    \n    \n"]],"start1":7302,"start2":7302,"length1":32,"length2":41},{"diffs":[[0,"    "],[-1,"\n    //Bullets\n    var shapes = this.bullets;\n    \n \n    // ** Add stuff you want drawn in the background all the time here **\n    this.tower.draw(this.ctx, this.mouse);\n    this.viewfinder.draw(this.ctx, this.mouse);\n \n    // draw all shapes\n    var l = ( shapes && shapes.length) ? shapes.length : 0;"],[1,"//draw bullets"],[0,"\n   "]],"start1":7343,"start2":7343,"length1":310,"length2":22},{"diffs":[[0,"(var i = 0; i < "],[1,"b"],[0,"l; i++) {\n      "]],"start1":7370,"start2":7370,"length1":32,"length2":33},{"diffs":[[0,"var "],[-1,"shape = shape"],[1,"bullet = bullet"],[0,"s[i]"]],"start1":7403,"start2":7403,"length1":21,"length2":23},{"diffs":[[0,"f (!"],[-1,"shape || shape"],[1,"bullet || bullet"],[0,".x >"]],"start1":7519,"start2":7519,"length1":22,"length2":24},{"diffs":[[0,"idth || "],[-1,"shape"],[1,"bullet"],[0,".y > thi"]],"start1":7550,"start2":7550,"length1":21,"length2":22},{"diffs":[[0,"    "],[-1,"shape.x + shape.w < 0 || shape.y + shape"],[1,"bullet.x + bullet.w < 0 || bullet.y + bullet"],[0,".h <"]],"start1":7590,"start2":7590,"length1":48,"length2":52},{"diffs":[[0," < 0 || "],[-1,"shape"],[1,"bullet"],[0,".offset "]],"start1":7640,"start2":7640,"length1":21,"length2":22},{"diffs":[[0,"            "],[-1,"shape"],[1,"bullet"],[0,"s[i] = false"]],"start1":7695,"start2":7695,"length1":29,"length2":30},{"diffs":[[0,"        "],[-1,"shape"],[1,"bullet"],[0,"s[i].dra"]],"start1":7791,"start2":7791,"length1":21,"length2":22},{"diffs":[[0,"i].draw(this.ctx"],[1,", i"],[0,");\n"],[1,"            \n"],[0,"        }\n    }\n"]],"start1":7807,"start2":7807,"length1":35,"length2":51},{"diffs":[[0,"   }\n    }\n    \n"],[1,"    this.drawInfo(this.ctx);\n    \n    // ** Add stuff you want drawn in the background all the time here **\n    this.tower.draw(this.ctx, this.mouse);\n    this.viewfinder.draw(this.ctx, this.mouse);\n    \n"],[0,"    if(this.toCl"]],"start1":7847,"start2":7847,"length1":32,"length2":236},{"diffs":[[0,"s = "],[-1,"shape"],[1,"bullet"],[0,"s.fi"]],"start1":8147,"start2":8147,"length1":13,"length2":14},{"diffs":[[0,"nemiesToClean > "],[-1,"2"],[1,"0"],[0,"){\n        //con"]],"start1":8292,"start2":8292,"length1":33,"length2":33},{"diffs":[[0,";\n    }\n"],[1,"    \n    \n    if(!level.enemies && !this.enemies.length){\n     //todo change level   \n     this.changeLevel();\n    }\n    \n    \n}\n\nGame.prototype.changeLevel = function(){\n    var that = this;\n this.enemies = [];\n this.bullets = [];\n this.currentLevel++;\n this.beforeStart = true;\n if(!this.levels[this.currentLevel]){\n    this.levels[this.currentLevel] = this.levels[this.currentLevel - 1];\n    this.levels[this.currentLevel].enemiesTimeout -= 50;\n    this.levels[this.currentLevel].bulletsTimeout -= 25;\n    this.levels[this.currentLevel].enemies = this.levels[this.currentLevel].startEnemies += 10;\n }\n var level = this.levels[this.currentLevel];\n this.bulletsTimeout = level.bulletsTimeout;\n this.enemiesTimeout = level.enemiesTimeout;\n this.blockClick = true;\n setTimeout(function(){\n     that.blockClick = false;\n }, 200);\n}\n\n\nGame.prototype.drawInfo = function(ctx){\n    ctx.fillStyle = 'red';\n    ctx.font = \"bold 30pt Calibri\";\n    ctx.fillText(new Array(this.lifes+1).join(\"â™¥\"), 20, this.height - 10);\n    \n    ctx.fillStyle = 'rgba(0,0,0, 0.9)';\n    ctx.font = \"bold 14pt Calibri\";\n    ctx.fillText(\"SCORE: \" + this.score, this.width / 2 + 20, this.height - 10);\n    \n    ctx.fillStyle = 'rgba(0,0,0, 0.6)';\n    ctx.font = \"bold 12pt Calibri\";\n    ctx.fillText(\"Level: \" + (this.currentLevel+1) + ' wave:'+this.levels[this.currentLevel].enemies, 10, 14);\n}\n\nGame.prototype.drawResult = function(ctx){    \n    ctx.fillStyle = 'red';\n    ctx.font = \"italic 30pt Calibri\";\n    ctx.fillText(\"GAME OVER!\", 10, 90);\n    ctx.font = \"italic 20pt Calibri\";\n    ctx.fillText(\"Killed: \" + this.score, 70, 140);\n    ctx.fillStyle = 'blue';\n    ctx.font = \"italic 15pt Calibri\";\n    ctx.fillText(\"Click to tweet your score!\", 20, 180);\n    ctx.font = \"italic 10pt Calibri\";\n    ctx.fillText(\"Refresh to play again :)\", 60, 200);\n}\n\nGame.prototype.drawSplash = function(ctx){ \n    if(this.currentLevel == 0){\n            \n        ctx.fillStyle = 'black';\n        ctx.font = \"bold 20pt Calibri\";\n        ctx.fillText(\"Click or tap to start!\", 10, 100);\n        ctx.font = \"13pt Calibri\";\n        ctx.fillText(\"Tip: click or tap for instant fire\", 10, 200);\n    }else{\n        ctx.fillStyle = 'black';\n        ctx.font = \"bold 18pt Calibri\";\n        ctx.fillText(\"Click or start level: \" + (this.currentLevel+1) , 10, 100);\n        ctx.font = \"13pt Calibri\";\n        ctx.fillText(\"Tip: click or tap for instant fire\", 10, 200);\n    }\n"],[0,"}"],[-1,"\n"],[0,"\n\n\nGame."]],"start1":8513,"start2":8513,"length1":18,"length2":2445}]],"length":11847,"saved":false}
{"ts":1349876252358,"patch":[[{"diffs":[[0,"this.mouse;\n"],[1,"        var newBullet; \n    \n"],[0,"        that"]],"start1":3557,"start2":3557,"length1":24,"length2":53},{"diffs":[[0,"-= 0.1;\n"],[1,"        var x = game.tower.x + (20 * d.dx);\n        var y = game.tower.y + (20 * d.dy);\n"],[0,"        "]],"start1":3626,"start2":3626,"length1":16,"length2":104},{"diffs":[[0,"    "],[-1,"game"],[1,"if(this"],[0,".bullets"],[-1,".push("],[1,"Pool.length){\n          "],[0," new"],[-1," "],[0,"Bullet"],[-1,"(game.tower.x + (20 * d.dx), game.tower.y + (20 * d.dy), 5, d.dx, d.dy, 'rgba(0, 0, 0, 1)')"],[1," = this.bulletsPool.pop();\n           newBullet.x = x;\n           newBullet.y = y;\n        }else{\n            newBullet = ew Bullet(x, y, 5, d.dx, d.dy, 'rgba(0, 0, 0, 1)');\n        }\n            \n        game.bullets.push( n"],[0," );\n"]],"start1":3785,"start2":3785,"length1":128,"length2":282}]],"length":12118,"saved":false}
{"ts":1349876352500,"patch":[[{"diffs":[[0,"ullet = "],[1,"n"],[0,"ew Bulle"]],"start1":3952,"start2":3952,"length1":16,"length2":17},{"diffs":[[0,".push( n"],[1,"ewBullet"],[0," );\n    "]],"start1":4056,"start2":4056,"length1":16,"length2":24},{"diffs":[[0,"{\n              "],[1,"this.bulletsPool.push(bullets[i]);"],[0,"\n              b"]],"start1":7956,"start2":7956,"length1":32,"length2":66}]],"length":12161,"saved":false}
{"ts":1349876410444,"patch":[[{"diffs":[[0,"-= 0.1;\n"],[1,"        \n        //todo\n        var d = game.tower.getDiffs(mouse);\n"],[0,"        "]],"start1":3626,"start2":3626,"length1":16,"length2":84},{"diffs":[[0,"y);\n"],[-1,"        //todo\n        var d = game.tower.getDiffs(mouse);\n"],[0,"    "]],"start1":3786,"start2":3786,"length1":67,"length2":8}]],"length":12170,"saved":false}
{"ts":1349876536301,"patch":[[{"diffs":[[0,"< 0 "],[-1,"|| bullet.offset > this.height"],[0,"){\n "]],"start1":7930,"start2":7930,"length1":38,"length2":8}]],"length":12140,"saved":false}
{"ts":1349876544349,"patch":[[{"diffs":[[0,"h(bullet"],[-1,"s[i]"],[0,");\n     "]],"start1":7971,"start2":7971,"length1":20,"length2":16}]],"length":12136,"saved":false}
{"ts":1349876596968,"patch":[[{"diffs":[[0,"[i].kill();\n"],[1,"                             this.bulletsPool.push(b);\n"],[0,"            "]],"start1":6578,"start2":6578,"length1":24,"length2":79}]],"length":12191,"saved":false}
{"ts":1349876804750,"patch":[[{"diffs":[[0,".y = y;\n"],[1,"           newBullet.dx = d.dx;\n           newBullet.dy = d.dy;\n"],[0,"        "]],"start1":3922,"start2":3922,"length1":16,"length2":80}]],"length":12255,"saved":false}
{"ts":1349876815420,"patch":[[{"diffs":[[0,"     if("],[-1,"this"],[1,"game"],[0,".bullets"]],"start1":3793,"start2":3793,"length1":20,"length2":20}]],"length":12255,"saved":false}
{"ts":1349876830597,"patch":[[{"diffs":[[0,"ullet = "],[-1,"this"],[1,"game"],[0,".bullets"]],"start1":3842,"start2":3842,"length1":20,"length2":20}]],"length":12255,"saved":false}
{"ts":1349876836378,"patch":[[{"diffs":[[0,"ol.length){\n"],[1,"            debugger;\n"],[0,"           n"]],"start1":3815,"start2":3815,"length1":24,"length2":46}]],"length":12277,"saved":false}
{"contributors":[],"silentsave":false,"ts":1349950031024,"patch":[[{"diffs":[[0,"vas, ctx"],[-1,""],[1,", width, height"],[0,"){\n    v"]],"start1":18,"start2":18,"length1":16,"length2":31},{"diffs":[[0,"= this;\n"],[-1,"    "],[1,""],[0,"\n    thi"]],"start1":57,"start2":57,"length1":20,"length2":16},{"diffs":[[0,"width = "],[-1,"canvas."],[0,"width;\n "]],"start1":121,"start2":121,"length1":23,"length2":16},{"diffs":[[0,"eight = "],[-1,"canvas."],[0,"height;\n"]],"start1":146,"start2":146,"length1":23,"length2":16},{"diffs":[[0,"s = [];\n"],[-1,"    "],[1,""],[0,"\n    thi"]],"start1":296,"start2":296,"length1":20,"length2":16},{"diffs":[[0,"er = false;\n"],[-1,"    "],[0,"\n    this.bu"]],"start1":770,"start2":770,"length1":28,"length2":24},{"diffs":[[0,"his."],[-1,"b"],[1,"lastB"],[0,"ullet"],[-1,"s"],[0,"Time"],[-1,"out"],[0," = "],[-1,"40"],[0,"0;\n    "],[-1,"function bulletsFactory(){\n        that.addBullet = true;        \n        setTimeout(bulletsFactory, that.bulletsTimeout);\n    }\n    bulletsFactory();\n    \n"],[1,"this.lastEnemyTime = 0;\n\n     this.bulletsTimeout = 400;\n "],[0,"    "]],"start1":788,"start2":788,"length1":190,"length2":90},{"diffs":[[0,"00;\n"],[1,"\n"],[0,"    "],[-1,"function enemiesFactory(){\n        that.addEnemy = true;\n        setTimeout(enemiesFactory, that.enemiesTimeout"],[1," this.canvas.addEventListener('click', Game.prototype.startGame.bind(this));\n        this.canvas.addEventListener('touchstart', Game.prototype.startGame.bind(this));\n\n         this.resetGameListener = this.resetGame.bind(this"],[0,");\n    "],[-1,"}\n"],[0,"    "],[-1,"enemiesFactory("],[1,"this.canvas.addEventListener('click', this.resetGameListener, false"],[0,");\n    "],[-1,"\n//"],[0,"    "]],"start1":901,"start2":901,"length1":161,"length2":323},{"diffs":[[0,"is.c"],[-1,"reateEnemies = setInterval("],[1,"anvas.addEventListener('touchstart', this.resetGameListener, false);\n}\n\nGame.prototype.resetGame = "],[0,"func"]],"start1":1226,"start2":1226,"length1":35,"length2":107},{"diffs":[[0,") {\n"],[-1,"//"],[0,"    "],[-1,"    that.addEnemy"],[1,"if(this.lifes > 0) return;\n    this.beforeStart"],[0," = t"]],"start1":1338,"start2":1338,"length1":31,"length2":59},{"diffs":[[0,"ue;\n"],[-1,"//"],[0,"    "],[-1,"}, 1000);\n    \n//     this.createBullets = setInterval(function() {\n//        that.addBullet = true;\n//    }, 400);\n    \n}"],[1,"this.currentLevel = 0;\n    this.updateLevel();\n    this.score = 0;\n    this.lifes = 3;\n    this.canvas.removeEventListener('click', this.resetGameListener, false);\n};"],[0,"\n\nGa"]],"start1":1398,"start2":1398,"length1":136,"length2":178},{"diffs":[[0,"tion(){\n"],[-1,"    "],[0,"\n}"],[1,";"],[0,"\n\nGame.p"]],"start1":1610,"start2":1610,"length1":22,"length2":19},{"diffs":[[0,"eight );"],[-1,"    "],[1,"\n"],[0,"\n}"],[1,";"],[0,"\n\nGame.p"]],"start1":2470,"start2":2470,"length1":22,"length2":20},{"diffs":[[0,"tion(){\n    "],[-1,"\n"],[1,"if(!this.tileCanvas){\n        this.tileCanvas = document.createElement( 'canvas' );\n\n        this.tileCanvas.width = this.width;\n        this.tileCanvas.height = this.height;\n\n        this.tileCanvasCtx = this.tileCanvas.getContext( '2d' );\n\n    "],[0,"    for (x ="]],"start1":2510,"start2":2510,"length1":25,"length2":270},{"diffs":[[0,"<= this."],[-1,"width"],[1,"height"],[0,"; y = y "]],"start1":2841,"start2":2841,"length1":21,"length2":22},{"diffs":[[0,"   this."],[-1,"c"],[1,"tileCanvasC"],[0,"tx.drawI"]],"start1":2884,"start2":2884,"length1":17,"length2":27},{"diffs":[[0,"    "],[-1,"\n}\n\n\n\n\nGame.prototype.draw = function(){\n    var that = this;\n    if(this.beforeStart){"],[1,"    //document.body.appendChild( this.tileCanvas );"],[0,"\n    "],[1,"}\n\n"],[0,"    "]],"start1":2959,"start2":2959,"length1":100,"length2":67},{"diffs":[[0,"is.c"],[-1,"lear();\n        this.drawSplash(this.ctx);\n        this.canvas.addEventListener('click',"],[1,"tx.drawImage(this.tileCanvas, 0, 0);\n\n};\n\nGame.prototype.startGame ="],[0," fun"]],"start1":3028,"start2":3028,"length1":96,"length2":76},{"diffs":[[0,"n(e)"],[1," "],[0,"{\n"],[-1,"            var timeout = 0;\n        "],[1,"\n"],[0,"    "]],"start1":3108,"start2":3108,"length1":47,"length2":12},{"diffs":[[0,"   if(th"],[-1,"at"],[1,"is"],[0,".blockCl"]],"start1":3117,"start2":3117,"length1":18,"length2":18},{"diffs":[[0,"    "],[-1,"        return;   \n            }           \n        "],[1,"return;\n    }\n"],[0,"    th"],[-1,"at"],[1,"is"],[0,".bef"]],"start1":3145,"start2":3145,"length1":68,"length2":30},{"diffs":[[0,"se;\n"],[-1,"        }"],[1,"};\n\n\n\nGame.prototype.frame = function(date){\n    if(this.beforeStart){\n        this.clear("],[0,");"],[1,"\n"],[0,"        "],[1,"this.drawSplash(this.ctx);\n"],[0,"\n   "]],"start1":3189,"start2":3189,"length1":27,"length2":136},{"diffs":[[0," return;"],[-1,"   "],[0,"\n    }\n "]],"start1":3329,"start2":3329,"length1":19,"length2":16},{"diffs":[[0,"tx);"],[-1,"  \n        \n        if(!this.tweetHandler){\n "],[1,"\n\n        return;\n"],[0,"    "],[-1,"   "],[1,"}\n\n"],[0,"    "]],"start1":3420,"start2":3420,"length1":60,"length2":33},{"diffs":[[0,"his."],[-1,"canvas.addEventListener('click',"],[1,"draw(date);\n};\n\n\n\n\nGame.prototype.draw ="],[0," fun"]],"start1":3454,"start2":3454,"length1":40,"length2":48},{"diffs":[[0,"ion("],[1,"dat"],[0,"e){\n    "],[-1,"            window.open( 'https://twitter.com/share?url='+\n                    encodeURIComponent(location.href)+\n                    '&text='+\n                    encodeURIComponent('Just ended Canon Defense! One of #js13kgames My score is: ' + that.score + '. Try the game at: ')\n                ,'_blank' );\n            });\n            this.tweetHandler = true;\n        }\n        return;\n    }\n    \n    if(this.addBulle"],[1,"//var that = this;\n    var i, enemy;\n\n    this.mouse = this.getMouse(this.e);\n\n    var bulletDiff = date - this.lastBulletTime;\n\n\n    if(this.addBullet || bulletDiff > this.bulletsTimeou"],[0,"t){\n"]],"start1":3504,"start2":3504,"length1":438,"length2":205},{"diffs":[[0,"wBullet;"],[-1," \n    "],[1,"\n"],[0,"\n       "]],"start1":3755,"start2":3755,"length1":22,"length2":17},{"diffs":[[0,"      th"],[-1,"at"],[1,"is"],[0,".bullets"]],"start1":3767,"start2":3767,"length1":18,"length2":18},{"diffs":[[0,"-= 0.1;\n"],[-1,"        "],[0,"\n       "]],"start1":3793,"start2":3793,"length1":24,"length2":16},{"diffs":[[0,"        var "],[-1,""],[1,"b"],[0,"x = game.tow"]],"start1":3861,"start2":3861,"length1":24,"length2":25},{"diffs":[[0,"h){\n"],[-1,"            debugger;"],[1,""],[0,"\n   "]],"start1":3983,"start2":3983,"length1":29,"length2":8},{"diffs":[[0,"let.x = "],[-1,""],[1,"b"],[0,"x;\n     "]],"start1":4052,"start2":4052,"length1":16,"length2":17},{"diffs":[[0," Bullet("],[1,"b"],[0,"x, y, 5,"]],"start1":4198,"start2":4198,"length1":16,"length2":17},{"diffs":[[0,"      }\n"],[-1,"            "],[0,"\n       "]],"start1":4251,"start2":4251,"length1":28,"length2":16},{"diffs":[[0," false;\n"],[1,"        this.lastBulletTime = date;\n"],[0,"    }\n"],[-1,"    "],[1,""],[0,"\n    var"]],"start1":4324,"start2":4324,"length1":26,"length2":58},{"diffs":[[0,"l];\n"],[-1,"    \n    \n    \n    \n    if(level.enemies && this.addEnemy){\n        "],[1,"\n\n    var enemyDiff = date - this.lastEnemyTime;\n\n    if(level.enemies && enemyDiff > this.enemiesTimeout){\n"],[0,"\n   "]],"start1":4419,"start2":4419,"length1":76,"length2":116},{"diffs":[[0,"-= 0.9;\n"],[-1,"        "],[0,"\n       "]],"start1":4560,"start2":4560,"length1":24,"length2":16},{"diffs":[[0,"        var "],[1,"e"],[0,"x = Math.flo"]],"start1":4569,"start2":4569,"length1":24,"length2":25},{"diffs":[[0,"    "],[-1,"//"],[0,"var "],[-1,"x = Math.floor(Math.random() * (this.width /2)) + this.width /2;\n        game.enemies.push("],[1,"newEnemy;\n\n        if(game.enemiesPool.length){\n\n           newEnemy = game.enemiesPool.pop();\n           newEnemy.reset();\n           newEnemy.x = ex;\n\n        }else{\n            newEnemy ="],[0," new"]],"start1":4641,"start2":4641,"length1":105,"length2":202},{"diffs":[[0,"w Enemy("],[1,"e"],[0,"x, 0, 26"]],"start1":4842,"start2":4842,"length1":16,"length2":17},{"diffs":[[0,"50, 1)')"],[1,";\n        }\n\n        game.enemies.push( newEnemy"],[0," );\n    "]],"start1":4880,"start2":4880,"length1":16,"length2":64},{"diffs":[[0,"nemy );\n        "],[1,"//"],[0,"this.addEnemy = "]],"start1":4932,"start2":4932,"length1":32,"length2":34},{"diffs":[[0,"dEnemy = false;\n"],[1,"        this.lastEnemyTime = date;\n"],[0,"        level.en"]],"start1":4957,"start2":4957,"length1":32,"length2":67},{"diffs":[[0,"th : 0;\n"],[-1,"    "],[1,""],[0,"\n    var"]],"start1":5250,"start2":5250,"length1":20,"length2":16},{"diffs":[[0," false;\n"],[-1,"    "],[1,""],[0,"\n    if("]],"start1":5306,"start2":5306,"length1":20,"length2":16},{"diffs":[[0,"){\n        for ("],[-1,"var"],[0," i = 0; i < l; i"]],"start1":5329,"start2":5329,"length1":35,"length2":32},{"diffs":[[0,"            "],[-1,"var "],[0,"enemy = enem"]],"start1":5367,"start2":5367,"length1":28,"length2":24},{"diffs":[[0,"se;\n"],[-1,"                        "],[1,""],[0,"\n   "]],"start1":5633,"start2":5633,"length1":32,"length2":8},{"diffs":[[0,"ue;\n"],[-1,"                             "],[1,""],[0,"\n   "]],"start1":6140,"start2":6140,"length1":37,"length2":8},{"diffs":[[0,"  }\n"],[-1,"                        "],[1,""],[0,"\n   "]],"start1":6167,"start2":6167,"length1":32,"length2":8},{"diffs":[[0,".w;\n"],[-1,"                        "],[0,"\n   "]],"start1":6414,"start2":6414,"length1":32,"length2":8},{"diffs":[[0,"ision &&"],[-1," "],[0,"\n       "]],"start1":6451,"start2":6451,"length1":17,"length2":16},{"diffs":[[0,"ue;\n"],[-1,"                             \n                        }\n                        \n                        "],[0,"\n   "]],"start1":6661,"start2":6661,"length1":113,"length2":8},{"diffs":[[0,"                "],[1,"}\n\n\n"],[0,"\n               "]],"start1":6674,"start2":6674,"length1":32,"length2":36},{"diffs":[[0,"    "],[-1,"this.bulletsPool.push(b);"],[1,"if(b){\n                                this.bulletsPool.push(b);\n                             }"],[0,"\n   "]],"start1":6860,"start2":6860,"length1":33,"length2":103},{"diffs":[[0,"      }\n"],[-1,"                       "],[1,""],[0,"\n       "]],"start1":7203,"start2":7203,"length1":39,"length2":16},{"diffs":[[0,"        }\n    }\n"],[-1,"    "],[1,""],[0,"\n    this.tile()"]],"start1":7266,"start2":7266,"length1":36,"length2":32},{"diffs":[[0,"tile();\n"],[-1,"    "],[0,"\n    for"]],"start1":7292,"start2":7292,"length1":20,"length2":16},{"diffs":[[0,"le();\n\n    for ("],[-1,"var "],[0,"i = 0; i < l; i+"]],"start1":7294,"start2":7294,"length1":36,"length2":32},{"diffs":[[0,"++) {\n      "],[-1,"var "],[0,"enemy = enem"]],"start1":7325,"start2":7325,"length1":28,"length2":24},{"diffs":[[0,"enemies[i];\n"],[-1,"      "],[0,"\n      // We"]],"start1":7345,"start2":7345,"length1":30,"length2":24},{"diffs":[[0,"ight ){\n"],[-1,"              "],[1,""],[0,"\n       "]],"start1":7472,"start2":7472,"length1":30,"length2":16},{"diffs":[[0,"}\n              "],[-1,""],[1,"if(enemy){\n                  this.enemiesPool.push(enemy);\n              }"],[0,"\n              e"]],"start1":7591,"start2":7591,"length1":32,"length2":106},{"diffs":[[0,"ntinue;\n"],[-1,"              "],[0,"\n       "]],"start1":7769,"start2":7769,"length1":30,"length2":16},{"diffs":[[0,"  }else{"],[-1,"            "],[0,"\n       "]],"start1":7784,"start2":7784,"length1":28,"length2":16},{"diffs":[[0,"draw(this.ctx, i"],[1,", date"],[0,");\n            i"]],"start1":7816,"start2":7816,"length1":32,"length2":38},{"diffs":[[0,".toRemove){\n"],[1,"                if(enemy){\n                    this.enemiesPool.push(enemy);\n                }\n"],[0,"            "]],"start1":7861,"start2":7861,"length1":24,"length2":119},{"diffs":[[0,"  }\n"],[-1,"        \n    }\n    "],[0,"\n    "],[1,"}\n\n"],[0,"\n   "]],"start1":8063,"start2":8063,"length1":32,"length2":16},{"diffs":[[0,"   for ("],[-1,"var"],[0," i = 0; "]],"start1":8096,"start2":8096,"length1":19,"length2":16},{"diffs":[[0,"ets[i];\n"],[-1,"      "],[1,""],[0,"\n      /"]],"start1":8150,"start2":8150,"length1":22,"length2":16},{"diffs":[[0,"et.h < 0 ){\n"],[1,"              if(bullet){\n  "],[0,"            "]],"start1":8360,"start2":8360,"length1":24,"length2":52},{"diffs":[[0,"ullet);\n"],[1,"              }\n"],[0,"        "]],"start1":8437,"start2":8437,"length1":16,"length2":32},{"diffs":[[0,"lean++;\n"],[-1,"              "],[1,""],[0,"\n       "]],"start1":8517,"start2":8517,"length1":30,"length2":16},{"diffs":[[0,"tx, i);\n"],[-1,"            "],[1,""],[0,"\n       "]],"start1":8575,"start2":8575,"length1":28,"length2":16},{"diffs":[[0,"    }\n    }\n"],[-1,"    "],[1,""],[0,"\n    this.dr"]],"start1":8588,"start2":8588,"length1":28,"length2":24},{"diffs":[[0,"s.ctx);\n"],[-1,"    "],[1,""],[0,"\n    // "]],"start1":8622,"start2":8622,"length1":20,"length2":16},{"diffs":[[0,"mouse);\n"],[-1,"    "],[1,""],[0,"\n    if("]],"start1":8788,"start2":8788,"length1":20,"length2":16},{"diffs":[[0,"tion(e){return e"],[-1,""],[1,"; "],[0,"});\n        //co"]],"start1":8900,"start2":8900,"length1":32,"length2":34},{"diffs":[[0,"return e"],[-1,""],[1,"; "],[0,"});\n    "]],"start1":9137,"start2":9137,"length1":16,"length2":18},{"diffs":[[0,";\n    }\n"],[-1,"    \n    "],[1,"\n"],[0,"\n    if("]],"start1":9247,"start2":9247,"length1":25,"length2":17},{"diffs":[[0,"ge level"],[-1,"   "],[1,""],[0,"\n     th"]],"start1":9321,"start2":9321,"length1":19,"length2":16},{"diffs":[[0,"  }\n"],[-1,"    \n    "],[1,"\n"],[0,"\n}"],[1,";"],[0,"\n\nGa"]],"start1":9357,"start2":9357,"length1":19,"length2":12},{"diffs":[[0,"tion(){\n"],[1,"\n"],[0,"    "],[1,"this.currentLevel++;\n    this.updateLevel();\n};\n\nGame.prototype.updateLevel = function(){\n    //"],[0,"var that"]],"start1":9400,"start2":9400,"length1":20,"length2":117},{"diffs":[[0," this;\n "],[1,"   while("],[0,"this.ene"]],"start1":9519,"start2":9519,"length1":16,"length2":25},{"diffs":[[0,"mies"],[-1," = [];\n this.bullets = [];\n this.currentLevel++;\n"],[1,".length){\n        this.enemiesPool.push(this.enemies.pop());\n    }\n    while(this.bullets.length){\n        this.bulletsPool.push(this.bullets.pop());\n    }\n   "],[0," thi"]],"start1":9544,"start2":9544,"length1":57,"length2":167},{"diffs":[[0,"= true;\n"],[1,"   "],[0," if(!thi"]],"start1":9725,"start2":9725,"length1":16,"length2":19},{"diffs":[[0,"+= 10;\n "],[-1,"}\n"],[1,"   }\n   "],[0," var lev"]],"start1":10050,"start2":10050,"length1":18,"length2":24},{"diffs":[[0,"Level];\n"],[1,"   "],[0," this.bu"]],"start1":10103,"start2":10103,"length1":16,"length2":19},{"diffs":[[0,"etsTimeout;\n"],[1,"   "],[0," this.enemie"]],"start1":10147,"start2":10147,"length1":24,"length2":27},{"diffs":[[0,"imeout;\n"],[1,"    //"],[0," this.bl"]],"start1":10199,"start2":10199,"length1":16,"length2":22},{"diffs":[[0,"= true;\n"],[1,"    //"],[0," setTime"]],"start1":10230,"start2":10230,"length1":16,"length2":22},{"diffs":[[0,"Timeout("],[1,"Game.prototype.runClicks.bind(this), 200);\n};\n\nGame.prototype.runClicks = "],[0,"function"]],"start1":10248,"start2":10248,"length1":16,"length2":90},{"diffs":[[0,"on()"],[1," "],[0,"{\n"],[-1," "],[0,"    th"],[-1,"at"],[1,"is"],[0,".blo"]],"start1":10336,"start2":10336,"length1":19,"length2":19},{"diffs":[[0,"se;\n"],[-1," }, 200);\n}\n"],[1,"};"],[0,"\n\nGa"]],"start1":10368,"start2":10368,"length1":20,"length2":10},{"diffs":[[0,"s.height - 10);\n"],[-1,"    "],[1,""],[0,"\n    ctx.fillSty"]],"start1":10539,"start2":10539,"length1":36,"length2":32},{"diffs":[[0," - 10);\n"],[-1,"    "],[1,""],[0,"\n    ctx"]],"start1":10705,"start2":10705,"length1":20,"length2":16},{"diffs":[[0,", 10, 14);\n}"],[1,";"],[0,"\n\nGame.proto"]],"start1":10890,"start2":10890,"length1":24,"length2":25},{"diffs":[[0,"on(ctx){"],[-1,"    "],[0,"\n    ctx"]],"start1":10939,"start2":10939,"length1":20,"length2":16},{"diffs":[[0,"ick "],[-1,"to tweet your score!\", 20, 180);\n    ctx.font = \"italic 10pt Calibri\";\n    ctx.fillText(\"Refresh"],[1,"or tap"],[0," to "]],"start1":11229,"start2":11229,"length1":104,"length2":14},{"diffs":[[0,"gain"],[-1," :)\", 60, 20"],[1,"!\", 20, 18"],[0,"0);\n}"],[1,";"],[0,"\n\nGa"]],"start1":11249,"start2":11249,"length1":25,"length2":24},{"diffs":[[0,"on(ctx){"],[-1," "],[0,"\n    if("]],"start1":11305,"start2":11305,"length1":17,"length2":16},{"diffs":[[0,"l =="],[1,"="],[0," 0){\n"],[-1,"            "],[0,"\n   "]],"start1":11337,"start2":11337,"length1":25,"length2":14},{"diffs":[[0,"    "],[-1,"ctx.font = \"13pt Calibri\";\n        ctx.fillText(\"Tip: click or tap for instant fire\", 10, 200);"],[1,""],[0,"\n   "]],"start1":11482,"start2":11482,"length1":103,"length2":8},{"diffs":[[0,"    "],[-1,"ctx.font = \"13pt Calibri\";\n        ctx.fillText(\"Tip: click or tap for instant fire\", 10, 200);"],[1,""],[0,"\n    }\n}"],[-1,""],[1,";"],[0,"\n\n\nG"]],"start1":11657,"start2":11657,"length1":111,"length2":17},{"diffs":[[0,"mx, my;\n"],[-1," "],[1,""],[0,"\n  // Co"]],"start1":11763,"start2":11763,"length1":17,"length2":16},{"diffs":[[0,"));\n  }\n"],[-1," "],[1,""],[0,"\n  // Ad"]],"start1":11972,"start2":11972,"length1":17,"length2":16},{"diffs":[[0,"etY;\n }\n"],[-1," "],[1,""],[0,"\n  // We"]],"start1":12454,"start2":12454,"length1":17,"length2":16},{"diffs":[[0,": my};\n}"],[-1,""],[1,";"],[0,"\n\n\n"]],"start1":12553,"start2":12553,"length1":11,"length2":12}]],"length":12565,"saved":false}
{"contributors":[],"silentsave":false,"ts":1350568829654,"patch":[[{"diffs":[[-1,"\nfunction Game(canvas, ctx, width, height){\n    var that = this;\n\n    this.canvas = canvas;\n    this.ctx = ctx;\n    this.width = width;\n    this.height = height;\n    this.mouse = {x: this.width/2, y: 0};\n    this.bulletsPool = [];\n    this.enemiesPool = [];\n    this.bullets = [];\n    this.enemies = [];\n\n    this.currentLevel = 0;\n    this.levels = [{\n        bulletsTimeout: 400,\n        enemiesTimeout: 600,\n        startEnemies: 30,\n        enemies: 30\n    }];\n    this.tower = new Tower(this.width/2, this.height, 10, 20, 'rgb(0,0,0)');\n    this.viewfinder = new Viewfinder(0, 0, 20, 20, 'rgb(0,0,0)');\n    this.toClean = 0;\n    this.enemiesToClean = 0;\n    this.addEnemy = 1;\n    this.score = 0;\n    this.lifes = 3;\n    this.beforeStart = true;\n    this.tweetHandler = false;\n\n    this.lastBulletTime = 0;\n    this.lastEnemyTime = 0;\n\n     this.bulletsTimeout = 400;\n     this.enemiesTimeout = 600;\n\n     this.canvas.addEventListener('click', Game.prototype.startGame.bind(this));\n        this.canvas.addEventListener('touchstart', Game.prototype.startGame.bind(this));\n\n         this.resetGameListener = this.resetGame.bind(this);\n        this.canvas.addEventListener('click', this.resetGameListener, false);\n        this.canvas.addEventListener('touchstart', this.resetGameListener, false);\n}\n\nGame.prototype.resetGame = function() {\n    if(this.lifes > 0) return;\n    this.beforeStart = true;\n    this.currentLevel = 0;\n    this.updateLevel();\n    this.score = 0;\n    this.lifes = 3;\n    this.canvas.removeEventListener('click', this.resetGameListener, false);\n};\n\nGame.prototype.startFactories = function(){\n\n};\n\nGame.prototype.image = new Image();\nGame.prototype.image.src = 'data:image/  png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AkLDSMPVfdqJwAAAWRJREFUOMttk79rwlAQxz9B5UEEFwmCZigGMhQydyiEjkKhf1P/HbeOmfo3FC2CgpkMFDIIAVOC2nSwl96L3vbuvbv7/rjnHA5v9XZXkaU5k6lH4Btcd4BEWRZsdxWBb9juqiYvZ2exntf6UjeSQmkozbI0B2Ay9ei8PD+9njqGwDfsizOPD3eMhn2Ox4p9cebz44vvHxgN+/R6htGwz3hsOHUMWZrj1PV7LZ11BL4BuJnXlJzFel5naU4c+xY8gDj2AXDdAUmyas6SA+gKF4Ao9Kzp+uFsdm8hKcsCwKYgha47sAQTUdt3AI7YKNNvqa1RiivyxrIxS3MLqsDU6DSthkKSrJop7YUqy6IpWG5ya6Gi0Ls0WG7yK+v0Qz29bauzWM/rKPSsSRq+LrxlcTfwDf8ILsKIoHqaXl+txdVfaG+bjraFzSK14YH3d/Zaol2aRCEN5W4bnqgvumgK4pA4UJYFvxvMELAqKY7sAAAAAElFTkSuQmCC';\n\nGame.prototype.clear = function(){\n    this.ctx.fillStyle = 'rgb(245,245,245)';\n    this.ctx.fillRect( 0, 0, this.width, this.height );\n\n};\n\nGame.prototype.tile = function(){\n    if(!this.tileCanvas){\n        this.tileCanvas = document.createElement( 'canvas' );\n\n        this.tileCanvas.width = this.width;\n        this.tileCanvas.height = this.height;\n\n        this.tileCanvasCtx = this.tileCanvas.getContext( '2d' );\n\n        for (x = 0; x <= this.width; x = x + 16) {\n            for (y = 0; y <= this.height; y = y + 16) {\n                this.tileCanvasCtx.drawImage(this.image, x, y);\n            }\n        }\n        //document.body.appendChild( this.tileCanvas );\n    }\n\n    this.ctx.drawImage(this.tileCanvas, 0, 0);\n\n};\n\nGame.prototype.startGame = function(e) {\n\n    if(this.blockClick){\n        return;\n    }\n    this.beforeStart = false;\n};\n\n\n\nGame.prototype.frame = function(date){\n    if(this.beforeStart){\n        this.clear();\n        this.drawSplash(this.ctx);\n\n        return;\n    }\n    if(this.lifes < 1){\n        this.clear();\n        this.drawResult(this.ctx);\n\n        return;\n    }\n\n    this.draw(date);\n};\n\n\n\n\nGame.prototype.draw = function(date){\n    //var that = this;\n    var i, enemy;\n\n    this.mouse = this.getMouse(this.e);\n\n    var bulletDiff = date - this.lastBulletTime;\n\n\n    if(this.addBullet || bulletDiff > this.bulletsTimeout){\n        var mouse = this.mouse;\n        var newBullet;\n\n        this.bulletsTimeout -= 0.1;\n\n        //todo\n        var d = game.tower.getDiffs(mouse);\n        var bx = game.tower.x + (20 * d.dx);\n        var y = game.tower.y + (20 * d.dy);\n        if(game.bulletsPool.length){\n\n           newBullet = game.bulletsPool.pop();\n           newBullet.x = bx;\n           newBullet.y = y;\n           newBullet.dx = d.dx;\n           newBullet.dy = d.dy;\n        }else{\n            newBullet = new Bullet(bx, y, 5, d.dx, d.dy, 'rgba(0, 0, 0, 1)');\n        }\n\n        game.bullets.push( newBullet );\n        this.addBullet = false;\n        this.lastBulletTime = date;\n    }\n\n    var level = this.levels[this.currentLevel];\n\n\n    var enemyDiff = date - this.lastEnemyTime;\n\n    if(level.enemies && enemyDiff > this.enemiesTimeout){\n\n        this.enemiesTimeout -= 0.9;\n\n        var ex = Math.floor(Math.random() * (this.width - 26)) + 2;\n        var newEnemy;\n\n        if(game.enemiesPool.length){\n\n           newEnemy = game.enemiesPool.pop();\n           newEnemy.reset();\n           newEnemy.x = ex;\n\n        }else{\n            newEnemy = new Enemy(ex, 0, 26, 32, 'rgba(125, 50, 50, 1)');\n        }\n\n        game.enemies.push( newEnemy );\n        //this.addEnemy = false;\n        this.lastEnemyTime = date;\n        level.enemies--;\n    }\n    //enemies\n    var enemies = this.enemies;\n    var l = ( enemies && enemies.length) ? enemies.length : 0;\n    //Bullets\n    var bullets = this.bullets;\n    var bl = ( bullets && bullets.length) ? bullets.length : 0;\n\n    var collision = false;\n    var yCollision = false;\n\n    if(l && bl){\n        for ( i = 0; i < l; i++) {\n            enemy = enemies[i];\n            if(enemy && enemy.live){\n                for (var j = 0; j < bl; j++) {\n                    var b = bullets[j];\n                    if(b){\n                        collision = false;\n                        yCollision = false;\n\n                        //a.y < b.y + b.height &&\n                        // a.y + a.height > b.y\n                        var eTopY = enemy.y;\n                        var eBottomY = enemy.y + enemy.h;\n                        var bTopY = b.y - b.w;\n                        var bBottomY = b.y + b.w;\n                        if( eTopY < bBottomY &&\n                         eBottomY > bTopY){\n                           //console.log('y collision b:'+j+' e:'+i);\n                           yCollision = true;\n\n                    "],[1,"window.Game = (function () {\n    function Game (width, height) {\n\n        this.width = width;\n        this.height = height;\n"],[0,"    }\n"],[-1,"\n"],[0,"    "],[-1,"                    //look for collisions\n                        var eLeftX = enemy.x;\n                        var eRightX = enemy.x + enemy.w;\n                        var bLeftX = b.x - b.w;\n                        var bRightX = b.x + b.w;\n\n                        if(yCollision &&\n                         eLeftX < bRightX &&\n                         eRightX > bLeftX ){\n                           //console.log('x collision b:'+j+' e:'+i);\n                           collision = true;\n\n                        }\n\n\n\n                        if(collision){\n                            console.log('BUUM!!!!');\n                             enemies[i].kill();\n                             if(b){\n                                this.bulletsPool.push(b);\n                             }\n                             bullets[j] = false;\n                             this.enemiesToClean++;\n                             this.toClean++;\n                             this.score++;\n                             break;\n                        }\n\n                    }\n                }\n            }\n        }\n    }\n\n    this.tile();\n\n    for (i = 0; i < l; i++) {\n      enemy = enemies[i];\n\n      // We can skip the drawing of elements that have moved off the screen:\n      if (!enemy || enemy.y > this.height ){\n\n              //enemy at the bottom!!!!!\n              if(enemy){\n                this.lifes--;\n              }\n              if(enemy){\n                  this.enemiesPool.push(enemy);\n              }\n              enemies[i] = false;\n              this.enemiesToClean++;\n              continue;\n\n        }else{\n            enemies[i].draw(this.ctx, i, date);\n            if(enemy.toRemove){\n                if(enemy){\n                    this.enemiesPool.push(enemy);\n                }\n                enemies[i] = false;\n                this.enemiesToClean++;\n            }\n        }\n\n    }\n\n\n    //draw bullets\n    for ( i = 0; i < bl; i++) {\n      var bullet = bullets[i];\n\n      // We can skip the drawing of elements that have moved off the screen:\n      if (!bullet || bullet.x > this.width || bullet.y > this.height ||\n          bullet.x + bullet.w < 0 || bullet.y + bullet.h < 0 ){\n              if(bullet){\n                this.bulletsPool.push(bullet);\n              }\n              bullets[i] = false;\n              this.toClean++;\n\n        }else{\n            bullets[i].draw(this.ctx, i);\n\n        }\n    }\n\n    this.drawInfo(this.ctx);\n\n    // ** Add stuff you want drawn in the background all the time here **\n    this.tower.draw(this.ctx, this.mouse);\n    this.viewfinder.draw(this.ctx, this.mouse);\n\n    if(this.toClean > 2){\n        //console.log('clean', l);\n        this.bullets = bullets.filter(function(e){return e; });\n        //console.log('cleaned: ', this.bullets.length);\n        this.toClean = 0;\n    }\n    if(this.enemiesToClean > 0){\n        //console.log('enemies clean', l);\n        this.enemies = enemies.filter(function(e){return e; });\n        //console.log('enemies cleaned: ', this.enemies.length);\n        this.enemiesToClean = 0;\n    }\n\n\n    if(!level.enemies && !this.enemies.length){\n     //todo change level\n     this.changeLevel();\n    }\n\n\n};\n\nGame.prototype.changeLevel = function(){\n\n    this.currentLevel++;\n    this.updateLevel();\n};\n\nGame.prototype.updateLevel = function(){\n    //var that = this;\n    while(this.enemies.length){\n        this.enemiesPool.push(this.enemies.pop());\n    }\n    while(this.bullets.length){\n        this.bulletsPool.push(this.bullets.pop());\n    }\n    this.beforeStart = true;\n    if(!this.levels[this.currentLevel]){\n    this.levels[this.currentLevel] = this.levels[this.currentLevel - 1];\n    this.levels[this.currentLevel].enemiesTimeout -= 50;\n    this.levels[this.currentLevel].bulletsTimeout -= 25;\n    this.levels[this.currentLevel].enemies = this.levels[this.currentLevel].startEnemies += 10;\n    }\n    var level = this.levels[this.currentLevel];\n    this.bulletsTimeout = level.bulletsTimeout;\n    this.enemiesTimeout = level.enemiesTimeout;\n    // this.blockClick = true;\n    // setTimeout(Game.prototype.runClicks.bind(this), 200);\n};\n\nGame.prototype.runClicks = function() {\n    this.blockClick = false;\n};\n\nGame.prototype.drawInfo = function(ctx){\n    ctx.fillStyle = 'red';\n    ctx.font = \"bold 30pt Calibri\";\n    ctx.fillText(new Array(this.lifes+1).join(\"â™¥\"), 20, this.height - 10);\n\n    ctx.fillStyle = 'rgba(0,0,0, 0.9)';\n    ctx.font = \"bold 14pt Calibri\";\n    ctx.fillText(\"SCORE: \" + this.score, this.width / 2 + 20, this.height - 10);\n\n    ctx.fillStyle = 'rgba(0,0,0, 0.6)';\n    ctx.font = \"bold 12pt Calibri\";\n    ctx.fillText(\"Level: \" + (this.currentLevel+1) + ' wave:'+this.levels[this.currentLevel].enemies, 10, 14);\n};\n\nGame.prototype.drawResult = function(ctx){\n    ctx.fillStyle = 'red';\n    ctx.font = \"italic 30pt Calibri\";\n    ctx.fillText(\"GAME OVER!\", 10, 90);\n    ctx.font = \"italic 20pt Calibri\";\n    ctx.fillText(\"Killed: \" + this.score, 70, 140);\n    ctx.fillStyle = 'blue';\n    ctx.font = \"italic 15pt Calibri\";\n    ctx.fillText(\"Click or tap to play again!\", 20, 180);\n};\n\nGame.prototype.drawSplash = function(ctx){\n    if(this.currentLevel === 0){\n\n        ctx.fillStyle = 'black';\n        ctx.font = \"bold 20pt Calibri\";\n        ctx.fillText(\"Click or tap to start!\", 10, 100);\n        \n    }else{\n        ctx.fillStyle = 'black';\n        ctx.font = \"bold 18pt Calibri\";\n        ctx.fillText(\"Click or start level: \" + (this.currentLevel+1) , 10, 100);\n        \n    }\n};\n\n\nGame.prototype.getMouse = function(e) {\n  var element = canvas, offsetX = 0, offsetY = 0, mx, my;\n\n  // Compute the total offset\n  if (element.offsetParent !== undefined) {\n    do {\n      offsetX += element.offsetLeft;\n      offsetY += element.offsetTop;\n    } while ((element = element.offsetParent));\n  }\n\n  // Add padding and border style widths to offset\n  // Also add the <html> offsets in case there's a position:fixed bar\n  //offsetX += this.stylePaddingLeft + this.styleBorderLeft + this.htmlLeft;\n  //offsetY += this.stylePaddingTop + this.styleBorderTop + this.htmlTop;\n if( e.targetTouches && e.targetTouches[0] ){\n     mx = e.targetTouches[0].pageX - offsetX;\n     my = e.targetTouches[0].pageY - offsetY;\n }else{\n      mx = e.pageX - offsetX;\n      my = e.pageY - offsetY;\n }\n\n  // We return a simple javascript object (a hash) with x and y defined\n  return {x: mx, y: my};\n};\n\n"],[1,"\n    Game.prototype.frame = function(dt){\n        this.game.frame(dt);\n    }\n    \n    return Game;\n    \n})();"],[0,"\n"]],"start1":0,"start2":0,"length1":12565,"length2":244}]],"length":244,"saved":false}
{"ts":1350569058643,"patch":[[{"diffs":[[0,"on () {\n"],[1,"    \n    self.postMessage(\"I'm working befor postMessage('ali').\");\n    self.onmessage = function(event) {\n      self.postMessage('Hi '+event.data.type+' '+event.data);\n    };\n        \n    \n"],[0,"    func"]],"start1":21,"start2":21,"length1":16,"length2":206}]],"length":434,"saved":false}
{"ts":1350569300296,"patch":[[{"diffs":[[-1,"window.Game = (function ("],[1,"self.postMessage(\"I'm working befor postMessage() and game\");\n    \n\nfunction Game (width, height"],[0,") {\n"],[1,"\n"],[0,"    "],[-1,"\n    "],[1,"this.width = width;\n    this.height = height;\n}\n\nGame.prototype.frame = function(dt){\n    this.game.frame(dt);\n}\n\n//init\n\n"],[0,"self"]],"start1":0,"start2":0,"length1":42,"length2":231},{"diffs":[[0,"age("],[-1,"'ali'"],[0,").\");\n"],[-1,"    "],[1,"\nself.game = new Game();\n\n"],[0,"self"]],"start1":271,"start2":271,"length1":23,"length2":40},{"diffs":[[0,"    "],[-1,"  self.postMessage('Hi '+event.data.type+' '+"],[1,"var data = "],[0,"even"]],"start1":342,"start2":342,"length1":53,"length2":19},{"diffs":[[0,"data"],[-1,")"],[0,";\n    "],[-1,"};"],[0,"\n    "],[-1,"    \n    \n    function Game (width, height) {\n"],[1,"var type = data.type;\n    if(type == 'size'){"],[0,"\n   "]],"start1":363,"start2":363,"length1":68,"length2":64},{"diffs":[[0,"'){\n        "],[-1,"this"],[1,"game"],[0,".width = wid"]],"start1":420,"start2":420,"length1":28,"length2":28},{"diffs":[[0,"   game.width = "],[1,"data."],[0,"width;\n        t"]],"start1":429,"start2":429,"length1":32,"length2":37},{"diffs":[[0,"th;\n        "],[-1,"this"],[1,"game"],[0,".height = he"]],"start1":453,"start2":453,"length1":28,"length2":28},{"diffs":[[0,"  game.height = "],[1,"data."],[0,"height;\n    }\n  "]],"start1":463,"start2":463,"length1":32,"length2":37},{"diffs":[[0," \n  "],[-1,"  Game.prototype.frame = function(dt){\n        this.game.frame(dt);\n    }\n    \n    return Game;\n    \n})();\n"],[1,"self.postMessage('Hi '+event.data.type+' '+event.data);\n};"]],"start1":501,"start2":501,"length1":111,"length2":62}]],"length":563,"saved":false}
{"ts":1350569344731,"patch":[[{"diffs":[[-1,"self.postMessage(\"I'm working befor postMessage() and game\");"],[1,"window.Game = (function () {"],[0,"\n    "],[-1,"\n\n"],[0,"func"]],"start1":0,"start2":0,"length1":72,"length2":37},{"diffs":[[0,"ght) {\n\n    "],[1,"   "],[1," "],[0,"this.width ="]],"start1":58,"start2":58,"length1":24,"length2":28},{"diffs":[[0,"th = width;\n"],[1,"    "],[0,"    this.hei"]],"start1":82,"start2":82,"length1":24,"length2":28},{"diffs":[[0,"height;\n"],[-1,"}\n\n"],[1,"    }\n    \n    "],[0,"Game.pro"]],"start1":116,"start2":116,"length1":19,"length2":31},{"diffs":[[0,"on(dt){\n"],[1,"    "],[0,"    this"]],"start1":168,"start2":168,"length1":16,"length2":20},{"diffs":[[0,"t);\n"],[-1,"}\n\n//init\n\nself.postMessage(\"I'm working befor postMessage().\");\n\nself.game = new Game();\n\nself.onmessage = function(event) {\n    var data = event.data;\n    \n    var type = data.type;\n    if(type == 'size'){\n        game.width = data.width;\n        game.height = data.height;\n    }\n    \n  self.postMessage('Hi '+event.data.type+' '+event.data"],[1,"    }\n    \n    return Game;\n    \n})("],[0,");\n"],[-1,"};"]],"start1":201,"start2":201,"length1":351,"length2":43}]],"length":244,"saved":false}
{"ts":1350569459977,"patch":[[{"diffs":[[0,") {\n"],[-1,"\n        this.width = width;\n        this.height = height"],[1,"        width = width || 100;\n        height = height || 100;\n        \n        this.width = width;\n        this.height = height;\n    }\n    \n    Game.prototype.frame = function(dt){\n        this.game.frame(dt)"],[0,";\n  "]],"start1":61,"start2":61,"length1":65,"length2":216}]],"length":395,"saved":false}
{"ts":1350569499201,"patch":[[{"diffs":[[0," Game.prototype."],[-1,"fram"],[1,"setSiz"],[0,"e = function(dt)"]],"start1":208,"start2":208,"length1":36,"length2":38},{"diffs":[[0,"ize = function(d"],[-1,"t"],[1,"ata"],[0,"){\n        this."]],"start1":228,"start2":228,"length1":33,"length2":35},{"diffs":[[0,"       this."],[-1,"game.frame(dt)"],[1,"width = data.width;\n        this.height = data.height"],[0,";\n    }\n    "]],"start1":251,"start2":251,"length1":38,"length2":77},{"diffs":[[0,"t){\n"],[1,""],[0,"        "],[-1,"this.game.frame(dt);"],[0,"\n   "]],"start1":366,"start2":366,"length1":36,"length2":16}]],"length":418,"saved":false}
{"ts":1350569542579,"patch":[[{"diffs":[[0,"t){\n        "],[1,"return 'hello from game! '+this.width+'x'+this.height;"],[0,"\n    }\n    \n"]],"start1":366,"start2":366,"length1":24,"length2":78}]],"length":472,"saved":false}
{"ts":1350569644079,"patch":[[{"diffs":[[-1,"window"],[1,"self"],[0,".Gam"]],"start1":0,"start2":0,"length1":10,"length2":8}]],"length":470,"saved":false}
{"ts":1350569873159,"patch":[[{"diffs":[[-1,"self.Game = (function () {\n    function Game (width, height) {\n        width = width || 100;\n        height = height || 100;\n        \n        this.width = width;\n        this.height = height;\n    }\n    \n    Game.prototype.setSize = function(data){\n        this.width = data.width;\n        this.height = data.height"],[1,"\nfunction Game(canvas, ctx, width, height){\n    var that = this;\n\n    this.canvas = canvas;\n    this.ctx = ctx;\n    this.width = width;\n    this.height = height;\n    this.mouse = {x: this.width/2, y: 0};\n    this.bulletsPool = [];\n    this.enemiesPool = [];\n    this.bullets = [];\n    this.enemies = [];\n\n    this.currentLevel = 0;\n    this.levels = [{\n        bulletsTimeout: 400,\n        enemiesTimeout: 600,\n        startEnemies: 30,\n        enemies: 30\n    }];\n    this.tower = new Tower(this.width/2, this.height, 10, 20, 'rgb(0,0,0)');\n    this.viewfinder = new Viewfinder(0, 0, 20, 20, 'rgb(0,0,0)');\n    this.toClean = 0;\n    this.enemiesToClean = 0;\n    this.addEnemy = 1;\n    this.score = 0;\n    this.lifes = 3;\n    this.beforeStart = true;\n    this.tweetHandler = false;\n\n    this.lastBulletTime = 0;\n    this.lastEnemyTime = 0;\n\n     this.bulletsTimeout = 400;\n     this.enemiesTimeout = 600;\n\n     this.canvas.addEventListener('click', Game.prototype.startGame.bind(this));\n        this.canvas.addEventListener('touchstart', Game.prototype.startGame.bind(this));\n\n         this.resetGameListener = this.resetGame.bind(this);\n        this.canvas.addEventListener('click', this.resetGameListener, false);\n        this.canvas.addEventListener('touchstart', this.resetGameListener, false);\n}\n\nGame.prototype.resetGame = function() {\n    if(this.lifes > 0) return;\n    this.beforeStart = true;\n    this.currentLevel = 0;\n    this.updateLevel();\n    this.score = 0;\n    this.lifes = 3;\n    this.canvas.removeEventListener('click', this.resetGameListener, false);\n};\n\nGame.prototype.startFactories = function(){\n\n};\n\nGame.prototype.image = new Image();\nGame.prototype.image.src = 'data:image/  png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AkLDSMPVfdqJwAAAWRJREFUOMttk79rwlAQxz9B5UEEFwmCZigGMhQydyiEjkKhf1P/HbeOmfo3FC2CgpkMFDIIAVOC2nSwl96L3vbuvbv7/rjnHA5v9XZXkaU5k6lH4Btcd4BEWRZsdxWBb9juqiYvZ2exntf6UjeSQmkozbI0B2Ay9ei8PD+9njqGwDfsizOPD3eMhn2Ox4p9cebz44vvHxgN+/R6htGwz3hsOHUMWZrj1PV7LZ11BL4BuJnXlJzFel5naU4c+xY8gDj2AXDdAUmyas6SA+gKF4Ao9Kzp+uFsdm8hKcsCwKYgha47sAQTUdt3AI7YKNNvqa1RiivyxrIxS3MLqsDU6DSthkKSrJop7YUqy6IpWG5ya6Gi0Ls0WG7yK+v0Qz29bauzWM/rKPSsSRq+LrxlcTfwDf8ILsKIoHqaXl+txdVfaG+bjraFzSK14YH3d/Zaol2aRCEN5W4bnqgvumgK4pA4UJYFvxvMELAqKY7sAAAAAElFTkSuQmCC';\n\nGame.prototype.clear = function(){\n    this.ctx.fillStyle = 'rgb(245,245,245)';\n    this.ctx.fillRect( 0, 0, this.width, this.height );\n\n};\n\nGame.prototype.tile = function(){\n    if(!this.tileCanvas){\n        this.tileCanvas = document.createElement( 'canvas' );\n\n        this.tileCanvas.width = this.width;\n        this.tileCanvas.height = this.height;\n\n        this.tileCanvasCtx = this.tileCanvas.getContext( '2d' );\n\n        for (x = 0; x <= this.width; x = x + 16) {\n            for (y = 0; y <= this.height; y = y + 16) {\n                this.tileCanvasCtx.drawImage(this.image, x, y);\n            }\n        }\n        //document.body.appendChild( this.tileCanvas );\n    }\n\n    this.ctx.drawImage(this.tileCanvas, 0, 0);\n\n};\n\nGame.prototype.startGame = function(e) {\n\n    if(this.blockClick){\n        return;\n    }\n    this.beforeStart = false;\n};\n\n\n\nGame.prototype.frame = function(date){\n    if(this.beforeStart){\n        this.clear();\n        this.drawSplash(this.ctx);\n\n        return;\n    }\n    if(this.lifes < 1){\n        this.clear();\n        this.drawResult(this.ctx);\n\n        return;\n    }\n\n    this.draw(date);\n};\n\n\n\n\nGame.prototype.draw = function(date){\n    //var that = this;\n    var i, enemy;\n\n    this.mouse = this.getMouse(this.e);\n\n    var bulletDiff = date - this.lastBulletTime;\n\n\n    if(this.addBullet || bulletDiff > this.bulletsTimeout){\n        var mouse = this.mouse;\n        var newBullet;\n\n        this.bulletsTimeout -= 0.1;\n\n        //todo\n        var d = game.tower.getDiffs(mouse);\n        var bx = game.tower.x + (20 * d.dx);\n        var y = game.tower.y + (20 * d.dy);\n        if(game.bulletsPool.length){\n\n           newBullet = game.bulletsPool.pop();\n           newBullet.x = bx;\n           newBullet.y = y;\n           newBullet.dx = d.dx;\n           newBullet.dy = d.dy;\n        }else{\n            newBullet = new Bullet(bx, y, 5, d.dx, d.dy, 'rgba(0, 0, 0, 1)');\n        }\n\n        game.bullets.push( newBullet );\n        this.addBullet = false;\n        this.lastBulletTime = date;\n    }\n\n    var level = this.levels[this.currentLevel];\n\n\n    var enemyDiff = date - this.lastEnemyTime;\n\n    if(level.enemies && enemyDiff > this.enemiesTimeout){\n\n        this.enemiesTimeout -= 0.9;\n\n        var ex = Math.floor(Math.random() * (this.width - 26)) + 2;\n        var newEnemy;\n\n        if(game.enemiesPool.length){\n\n           newEnemy = game.enemiesPool.pop();\n           newEnemy.reset();\n           newEnemy.x = ex;\n\n        }else{\n            newEnemy = new Enemy(ex, 0, 26, 32, 'rgba(125, 50, 50, 1)');\n        }\n\n        game.enemies.push( newEnemy );\n        //this.addEnemy = false;\n        this.lastEnemyTime = date;\n        level.enemies--;\n    }\n    //enemies\n    var enemies = this.enemies;\n    var l = ( enemies && enemies.length) ? enemies.length : 0;\n    //Bullets\n    var bullets = this.bullets;\n    var bl = ( bullets && bullets.length) ? bullets.length : 0;\n\n    var collision = false;\n    var yCollision = false;\n\n    if(l && bl){\n        for ( i = 0; i < l; i++) {\n            enemy = enemies[i];\n            if(enemy && enemy.live){\n                for (var j = 0; j < bl; j++) {\n                    var b = bullets[j];\n                    if(b){\n                        collision = false;\n                        yCollision = false;\n\n                        //a.y < b.y + b.height &&\n                        // a.y + a.height > b.y\n                        var eTopY = enemy.y;\n                        var eBottomY = enemy.y + enemy.h;\n                        var bTopY = b.y - b.w;\n                        var bBottomY = b.y + b.w;\n                        if( eTopY < bBottomY &&\n                         eBottomY > bTopY){\n                           //console.log('y collision b:'+j+' e:'+i);\n                           yCollision = true;\n\n                        }\n\n                        //look for collisions\n                        var eLeftX = enemy.x;\n                        var eRightX = enemy.x + enemy.w;\n                        var bLeftX = b.x - b.w;\n                        var bRightX = b.x + b.w;\n\n                        if(yCollision &&\n                         eLeftX < bRightX &&\n                         eRightX > bLeftX ){\n                           //console.log('x collision b:'+j+' e:'+i);\n                           collision = true;\n\n                        }\n\n\n\n                        if(collision){\n                            console.log('BUUM!!!!');\n                             enemies[i].kill();\n                             if(b){\n                                this.bulletsPool.push(b);\n                             }\n                             bullets[j] = false;\n                             this.enemiesToClean++;\n                             this.toClean++;\n                             this.score++;\n                             break;\n                        }\n\n                    }\n                }\n            }\n        }\n    }\n\n    this.tile();\n\n    for (i = 0; i < l; i++) {\n      enemy = enemies[i];\n\n      // We can skip the drawing of elements that have moved off the screen:\n      if (!enemy || enemy.y > this.height ){\n\n              //enemy at the bottom!!!!!\n              if(enemy){\n                this.lifes--;\n              }\n              if(enemy){\n                  this.enemiesPool.push(enemy);\n              }\n              enemies[i] = false;\n              this.enemiesToClean++;\n              continue;\n\n        }else{\n            enemies[i].draw(this.ctx, i, date);\n            if(enemy.toRemove){\n                if(enemy){\n                    this.enemiesPool.push(enemy);\n                }\n                enemies[i] = false;\n                this.enemiesToClean++;\n            }\n        }\n\n    }\n\n\n    //draw bullets\n    for ( i = 0; i < bl; i++) {\n      var bullet = bullets[i];\n\n      // We can skip the drawing of elements that have moved off the screen:\n      if (!bullet || bullet.x > this.width || bullet.y > this.height ||\n          bullet.x + bullet.w < 0 || bullet.y + bullet.h < 0 ){\n              if(bullet){\n                this.bulletsPool.push(bullet);\n              }\n              bullets[i] = false;\n              this.toClean++;\n\n        }else{\n            bullets[i].draw(this.ctx, i);\n\n        }\n    }\n\n    this.drawInfo(this.ctx);\n\n    // ** Add stuff you want drawn in the background all the time here **\n    this.tower.draw(this.ctx, this.mouse);\n    this.viewfinder.draw(this.ctx, this.mouse);\n\n    if(this.toClean > 2){\n        //console.log('clean', l);\n        this.bullets = bullets.filter(function(e){return e; });\n        //console.log('cleaned: ', this.bullets.length);\n        this.toClean = 0;\n    }\n    if(this.enemiesToClean > 0){\n        //console.log('enemies clean', l);\n        this.enemies = enemies.filter(function(e){return e; });\n        //console.log('enemies cleaned: ', this.enemies.length);\n        this.enemiesToClean = 0"],[0,";\n    }\n"],[1,"\n\n"],[0,"    "],[-1,"\n    Game.prototype.frame = function(dt){\n        return 'hello from game! '+this.width+'x'+this.height;\n    }\n    \n    return Game"],[1,"if(!level.enemies && !this.enemies.length){\n     //todo change level\n     this.changeLevel();\n    }\n\n\n};\n\nGame.prototype.changeLevel = function(){\n\n    this.currentLevel++;\n    this.updateLevel();\n};\n\nGame.prototype.updateLevel = function(){\n    //var that = this;\n    while(this.enemies.length){\n        this.enemiesPool.push(this.enemies.pop());\n    }\n    while(this.bullets.length){\n        this.bulletsPool.push(this.bullets.pop());\n    }\n    this.beforeStart = true;\n    if(!this.levels[this.currentLevel]){\n    this.levels[this.currentLevel] = this.levels[this.currentLevel - 1];\n    this.levels[this.currentLevel].enemiesTimeout -= 50;\n    this.levels[this.currentLevel].bulletsTimeout -= 25;\n    this.levels[this.currentLevel].enemies = this.levels[this.currentLevel].startEnemies += 10;\n    }\n    var level = this.levels[this.currentLevel];\n    this.bulletsTimeout = level.bulletsTimeout;\n    this.enemiesTimeout = level.enemiesTimeout;\n    // this.blockClick = true;\n    // setTimeout(Game.prototype.runClicks.bind(this), 200);\n};\n\nGame.prototype.runClicks = function() {\n    this.blockClick = false;\n};\n\nGame.prototype.drawInfo = function(ctx){\n    ctx.fillStyle = 'red';\n    ctx.font = \"bold 30pt Calibri\";\n    ctx.fillText(new Array(this.lifes+1).join(\"â™¥\"), 20, this.height - 10);\n\n    ctx.fillStyle = 'rgba(0,0,0, 0.9)';\n    ctx.font = \"bold 14pt Calibri\";\n    ctx.fillText(\"SCORE: \" + this.score, this.width / 2 + 20, this.height - 10);\n\n    ctx.fillStyle = 'rgba(0,0,0, 0.6)';\n    ctx.font = \"bold 12pt Calibri\";\n    ctx.fillText(\"Level: \" + (this.currentLevel+1) + ' wave:'+this.levels[this.currentLevel].enemies, 10, 14);\n};\n\nGame.prototype.drawResult = function(ctx){\n    ctx.fillStyle = 'red';\n    ctx.font = \"italic 30pt Calibri\";\n    ctx.fillText(\"GAME OVER!\", 10, 90);\n    ctx.font = \"italic 20pt Calibri\";\n    ctx.fillText(\"Killed: \" + this.score, 70, 140);\n    ctx.fillStyle = 'blue';\n    ctx.font = \"italic 15pt Calibri\";\n    ctx.fillText(\"Click or tap to play again!\", 20, 180);\n};\n\nGame.prototype.drawSplash = function(ctx){\n    if(this.currentLevel === 0){\n\n        ctx.fillStyle = 'black';\n        ctx.font = \"bold 20pt Calibri\";\n        ctx.fillText(\"Click or tap to start!\", 10, 100);\n        \n    }else{\n        ctx.fillStyle = 'black';\n        ctx.font = \"bold 18pt Calibri\";\n        ctx.fillText(\"Click or start level: \" + (this.currentLevel+1) , 10, 100);\n        \n    }\n};\n\n\nGame.prototype.getMouse = function(e) {\n  var element = canvas, offsetX = 0, offsetY = 0, mx, my"],[0,";\n"],[1,"\n"],[0,"  "],[-1,"  \n})();"],[1,"// Compute the total offset\n  if (element.offsetParent !== undefined) {\n    do {\n      offsetX += element.offsetLeft;\n      offsetY += element.offsetTop;\n    } while ((element = element.offsetParent));\n  }\n\n  // Add padding and border style widths to offset\n  // Also add the <html> offsets in case there's a position:fixed bar\n  //offsetX += this.stylePaddingLeft + this.styleBorderLeft + this.htmlLeft;\n  //offsetY += this.stylePaddingTop + this.styleBorderTop + this.htmlTop;\n if( e.targetTouches && e.targetTouches[0] ){\n     mx = e.targetTouches[0].pageX - offsetX;\n     my = e.targetTouches[0].pageY - offsetY;\n }else{\n      mx = e.pageX - offsetX;\n      my = e.pageY - offsetY;\n }\n\n  // We return a simple javascript object (a hash) with x and y defined\n  return {x: mx, y: my};\n};\n\n"],[0,"\n"]],"start1":0,"start2":0,"length1":470,"length2":12565}]],"length":12565,"saved":false}
